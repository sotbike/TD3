library(meta)
library(metafor)
library(metasens)

trifecta <- read.csv("C:/Users/sotbi/Desktop/trifecta.csv", sep=";", na.strings="")
trifecta <-trifecta[c(1:11),]

############# FIXED EFFECTS MODEL ###########

# Pooled Analysis

# Meta Regression Analysis (Pooled)
metareg_peto_fe<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta, append = TRUE)
metareg_peto_fema<-rma(yi, vi, data = metareg_peto_fe, method = "FE", mods = ~year)
metareg_peto_fema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_fema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_fe$vi+metareg_peto_fema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_fe$year, metareg_peto_fe$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "red")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Subgroup Analysis

# Meta Regression Analysis (Studies with patient matching)
metareg_peto_fe<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$matching=="Studies with patient matching",], append = TRUE)
metareg_peto_fema<-rma(yi, vi, data = metareg_peto_fe, method = "FE", mods = ~year)
metareg_peto_fema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_fema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_fe$vi+metareg_peto_fema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_fe$year, metareg_peto_fe$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "darkgreen")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (Studies without patient matching)
metareg_peto_fe<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$matching=="Studies without patient matching",], append = TRUE)
metareg_peto_fema<-rma(yi, vi, data = metareg_peto_fe, method = "FE", mods = ~year)
metareg_peto_fema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_fema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_fe$vi+metareg_peto_fema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_fe$year, metareg_peto_fe$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "lightgreen")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (Multicenter Studies)
metareg_peto_fe<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$center=="Multicenter Studies",], append = TRUE)
metareg_peto_fema<-rma(yi, vi, data = metareg_peto_fe, method = "FE", mods = ~year)
metareg_peto_fema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_fema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_fe$vi+metareg_peto_fema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_fe$year, metareg_peto_fe$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "blue")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (Single-center Studies)
metareg_peto_fe<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$center=="Single-center Studies",], append = TRUE)
metareg_peto_fema<-rma(yi, vi, data = metareg_peto_fe, method = "FE", mods = ~year)
metareg_peto_fema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_fema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_fe$vi+metareg_peto_fema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_fe$year, metareg_peto_fe$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "lightblue")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (ΔeGFR < 10% as measure of postoperative renal function)
metareg_peto_fe<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$definition=="ΔeGFR < 10% as measure of postoperative renal function",], append = TRUE)
metareg_peto_fema<-rma(yi, vi, data = metareg_peto_fe, method = "FE", mods = ~year)
metareg_peto_fema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_fema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_fe$vi+metareg_peto_fema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_fe$year, metareg_peto_fe$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "purple")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (IT < 25min as measure of postoperative renal function)
metareg_peto_fe<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$definition=="IT < 25min as measure of postoperative renal function",], append = TRUE)
metareg_peto_fema<-rma(yi, vi, data = metareg_peto_fe, method = "FE", mods = ~year)
metareg_peto_fema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_fema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_fe$vi+metareg_peto_fema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_fe$year, metareg_peto_fe$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "pink")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")



############# RANDOM EFFECTS MODEL ###########

# Pooled Analysis

# Meta Regression Analysis (Pooled)
metareg_peto_re<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta, append = TRUE)
metareg_peto_rema<-rma(yi, vi, data = metareg_peto_re, method = "REML", mods = ~year)
metareg_peto_rema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_rema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_re$vi+metareg_peto_rema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_re$year, metareg_peto_re$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "red")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Subgroup Analysis

# Meta Regression Analysis (Studies with patient matching)
metareg_peto_re<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$matching=="Studies with patient matching",], append = TRUE)
metareg_peto_rema<-rma(yi, vi, data = metareg_peto_re, method = "REML", mods = ~year)
metareg_peto_rema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_rema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_re$vi+metareg_peto_rema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_re$year, metareg_peto_re$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "darkgreen")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (Studies without patient matching)
metareg_peto_re<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$matching=="Studies without patient matching",], append = TRUE)
metareg_peto_rema<-rma(yi, vi, data = metareg_peto_re, method = "REML", mods = ~year)
metareg_peto_rema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_rema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_re$vi+metareg_peto_rema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_re$year, metareg_peto_re$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "lightgreen")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (Multicenter Studies)
metareg_peto_re<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$center=="Multicenter Studies",], append = TRUE)
metareg_peto_rema<-rma(yi, vi, data = metareg_peto_re, method = "REML", mods = ~year)
metareg_peto_rema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_rema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_re$vi+metareg_peto_rema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_re$year, metareg_peto_re$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "blue")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (Single-center Studies)
metareg_peto_re<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$center=="Single-center Studies",], append = TRUE)
metareg_peto_rema<-rma(yi, vi, data = metareg_peto_re, method = "REML", mods = ~year)
metareg_peto_rema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_rema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_re$vi+metareg_peto_rema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_re$year, metareg_peto_re$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "lightblue")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (ΔeGFR < 10% as measure of postoperative renal function)
metareg_peto_re<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$definition=="ΔeGFR < 10% as measure of postoperative renal function",], append = TRUE)
metareg_peto_rema<-rma(yi, vi, data = metareg_peto_re, method = "REML", mods = ~year)
metareg_peto_rema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_rema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_re$vi+metareg_peto_rema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_re$year, metareg_peto_re$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "purple")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


# Meta Regression Analysis (IT < 25min as measure of postoperative renal function)
metareg_peto_re<-escalc(measure = "OR",ai = evexp, bi = nonevexp, ci = evctrl, di = nonevctrl, data = trifecta [trifecta$definition=="IT < 25min as measure of postoperative renal function",], append = TRUE)
metareg_peto_rema<-rma(yi, vi, data = metareg_peto_re, method = "REML", mods = ~year)
metareg_peto_rema
yearvec<-seq(min(trifecta$year), max(trifecta$year), 1)
preds<-predict(metareg_peto_rema, newmods = yearvec)
wi<-1/sqrt(metareg_peto_re$vi+metareg_peto_rema$tau2)
size<-1+2*(wi - min(wi)) / (max(wi) - min(wi))
plot(metareg_peto_re$year, metareg_peto_re$yi, pch = 1, cex = size, xlim = c(2015, 2022), ylim = c(-3, 3), ylab = "log[Peto Odds Ratio] (Experimental: RAPN vs Control: OPN)", xlab = "Year")
lines(yearvec, preds$pred, lwd = 2, col = "pink")
lines(yearvec, preds$ci.lb, lty = "dashed")
lines(yearvec, preds$ci.ub, lty = "dashed")
abline(h=0, lwd = 2, lty = "dotted")


